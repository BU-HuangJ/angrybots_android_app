package Messaging;

import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.AsynchronousServerSocketChannel;
import java.nio.channels.AsynchronousSocketChannel;
import java.nio.channels.CompletionHandler;
import java.sql.SQLException;
import java.util.concurrent.ExecutionException;

import base.Member;
import base.RPCEntry;
import base.RPC_Match;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.stream.JsonWriter;

public class AIOServer extends Server{
	private AsynchronousServerSocketChannel sock;
	public AIOServer() throws ClassNotFoundException, IOException, SQLException {
		sock = AsynchronousServerSocketChannel.open().bind(new InetSocketAddress(9999));
		System.out.println("listening");
		accecpt_conn();	
	}
	
	public void run(){
		while(true){
			RPC_Match match = null;
			if((match = rpc_handler.getMatchup()) != null){
				AsynchronousSocketChannel human_channel = match.getHuman().getClient().getChannel();
				AsynchronousSocketChannel robot_channel = match.getRobot().getClient().getChannel();
				Response rsp = new Response(match.getHash_key());
				try {
					System.out.println("Notifying players");
					write(human_channel,rsp);
					write(robot_channel,rsp);
					match.getHuman().getClient().reRead();
					match.getRobot().getClient().reRead();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			}
		}
	}
	public void accecpt_conn(){
		sock.accept(this, new CompletionHandler<AsynchronousSocketChannel,AIOServer>(){
			@Override
			public void completed(AsynchronousSocketChannel result,
					AIOServer attachment) {
				System.out.println("got conn");
				handle(new IOPair(attachment,result));
				attachment.accecpt_conn();
			}

			@Override
			public void failed(Throwable exc, AIOServer attachment) {
				// TODO Auto-generated method stub
				System.out.println("failed");
			}});
	}
	
	protected void setGot(boolean b) {
		// TODO Auto-generated method stub
		
	}

	public void write(AsynchronousSocketChannel clnt, Message msg) throws IOException{
		ByteArrayOutputStream stream = new ByteArrayOutputStream();
		OutputStreamWriter writer = new OutputStreamWriter(stream);
		JsonWriter w = new JsonWriter(writer);
		msg.encode(w);
		DEBUG("->"+msg.toString());
		stream.write("\n".getBytes());
		ByteBuffer buf = ByteBuffer.wrap(stream.toByteArray());
		clnt.write(buf,null,new CompletionHandler<Integer,ByteBuffer>(){
			@Override
			public void completed(Integer result, ByteBuffer attachment) {
				
			}

			@Override
			public void failed(Throwable exc, ByteBuffer attachment) {
				// TODO Auto-generated method stub
				
			}});
	}
	public void respond_to(AsynchronousSocketChannel clnt, JsonObject obj) throws SQLException, IOException{
		Message reply = get_response(obj);
		write(clnt,reply);
	}
	public void handle(IOPair io){
		final ByteBuffer buf = io.getBuffer();
		io.getChannel().read(buf, io, new CompletionHandler<Integer,IOPair>(){
			@Override
			public void completed(Integer result, IOPair attachment) {		
				if(result > 0){
					try {
						JsonObject read = attachment.read(result);
						DEBUG("<-" + read.toString());
						if(read != null){
							String type = read.get("id").getAsString();
							if(type.compareTo(RPC_Request.TYPE) == 0){
								RPC_Request req = new RPC_Request(read);
								System.out.println(req.toString());
								Member m = db.getMember(req.getMember_id());
								rpc_handler.queue(new RPCEntry(attachment,m));
							}else if(type.compareTo(RPC_Action.TYPE) == 0){
								System.out.println("GOT ACTION!");
								RPC_Action action = new RPC_Action(read);
								rpc_handler.process(action);
								RPC_Match m = rpc_handler.findMatch(action.getKey());
								RPCEntry r_winner = null;
								RPCEntry r_loser = null;
								if(m.isDone()){
									int winner = m.getResult();
									System.out.println("Winner: " + winner);
									switch(winner){
										case -1: //robot winner;
											r_winner = m.getRobot();
											r_loser = m.getHuman();
											break;
										case 0: //tie
											break;
										case 1: //human winner
											r_loser = m.getRobot();
											r_winner = m.getHuman();
									}
									
									Response winner_rsp = new Response("winner");
									Response loser_rsp = new Response("loser");
									Response tie_rsp = new Response("tie");
									if(r_loser != null && r_winner != null){
										write(r_winner.getClient().getChannel(),winner_rsp);
										write(r_loser.getClient().getChannel(),loser_rsp);
									}else{
										write(m.getHuman().getClient().getChannel(),tie_rsp);
										write(m.getRobot().getClient().getChannel(),tie_rsp);
									}
									m.getRobot().getClient().reRead();
									m.getHuman().getClient().reRead();
									rpc_handler.removeMatch(m.getHash_key());
								}
							}else{
								attachment.respond_to(read);
								attachment.reRead();
							}
						}	
					} catch (SQLException | IOException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					} catch (Exception e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				}

			}

			@Override
			public void failed(Throwable exc, IOPair attachment) {
				// TODO Auto-generated method stub
				
			}});
	}
	public class IOPair{
		private AsynchronousSocketChannel clnt;
		private final ByteBuffer buf;
		private AIOServer serv;
		public int totalRead =0;
		public IOPair(AIOServer serv, AsynchronousSocketChannel clnt){
			this.serv = serv;
			this.clnt = clnt;
			this.buf = ByteBuffer.allocate(1024);
		}
		public IOPair(AIOServer serv,ByteBuffer buf, AsynchronousSocketChannel clnt){
			this.serv = serv;
			this.clnt = clnt;
			this.buf = buf;
		}
		
		public AsynchronousSocketChannel getChannel(){
			return clnt;
		}
		
		public void reRead(){
			serv.handle(this);
		}
		public void respond_to(JsonObject o) throws SQLException, IOException{
			serv.respond_to(clnt,o);
		}
		
		public ByteBuffer getBuffer(){
			return buf;
		}
		public JsonObject read(int i){
			totalRead += i;
			buf.flip();
			byte[] dst = new byte[totalRead];
			buf.get(dst);
			String s = new String(dst);
			JsonObject o = null;
			try{
				o = getFrom(s);
			}catch (Exception e){
				System.out.println("EXCEPTION");
				buf.position(totalRead);
			}
			if(o != null){
				buf.clear();
				totalRead = 0;
				return o;
			}
			return null;
		}
	}
	
	public static void main(String[] args){
		try {
			AIOServer serv = new AIOServer();
			serv.run();
		} catch (ClassNotFoundException | IOException | SQLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		
	}
}
